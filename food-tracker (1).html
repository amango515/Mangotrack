<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MangoTrack</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0e0f0c;
    --surface: #161712;
    --border: #2a2b26;
    --accent: #c8f060;
    --text: #e8e9e0;
    --muted: #6a6b60;
    --protein: #f06060;
    --carbs: #f0a030;
    --fat: #c8f060;
    --cal: #a060f0;
    --fibre: #40c8a0;
    --vit: #60b0f0;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    padding: 40px 20px;
    background-image: radial-gradient(ellipse at 20% 20%, #1a2010 0%, transparent 50%),
                      radial-gradient(ellipse at 80% 80%, #101820 0%, transparent 50%);
  }

  .container { max-width: 1400px; margin: 0 auto; }
  header { margin-bottom: 40px; }

  h1 {
    font-family: 'Fraunces', serif;
    font-size: clamp(2.5rem, 6vw, 4rem);
    font-weight: 300;
    line-height: 1;
    color: var(--accent);
    letter-spacing: -0.02em;
  }
  h1 em { font-style: italic; color: var(--text); }

  .subtitle {
    color: var(--muted);
    font-size: 0.75rem;
    margin-top: 8px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .input-row { display: flex; gap: 10px; margin-bottom: 32px; }

  input[type="text"] {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px 18px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type="text"]:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(200,240,96,0.08);
  }
  input[type="text"]::placeholder { color: var(--muted); }

  button.add-btn {
    background: var(--accent);
    border: none;
    border-radius: 6px;
    padding: 14px 24px;
    color: var(--bg);
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    letter-spacing: 0.05em;
  }
  button.add-btn:hover { background: #d4f572; transform: translateY(-1px); }
  button.add-btn:active { transform: translateY(0); }
  button.add-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .loading-bar {
    height: 2px;
    background: var(--border);
    border-radius: 2px;
    margin-bottom: 24px;
    overflow: hidden;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .loading-bar.active { opacity: 1; }
  .loading-bar::after {
    content: '';
    display: block;
    height: 100%;
    width: 40%;
    background: var(--accent);
    border-radius: 2px;
    animation: slide 1s infinite ease-in-out;
  }
  @keyframes slide {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(350%); }
  }

  .error-toast {
    background: rgba(240,96,96,0.1);
    border: 1px solid rgba(240,96,96,0.3);
    border-radius: 6px;
    padding: 12px 16px;
    color: var(--protein);
    font-size: 0.8rem;
    margin-bottom: 16px;
    display: none;
  }
  .error-toast.show { display: block; }

  /* Layout: food log on top, two charts side by side below */
  .log-section {
    margin-bottom: 24px;
  }

  .charts-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    align-items: start;
  }

  /* Shared chart panel */
  .chart-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
  }

  .chart-panel-title {
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 20px;
  }

  .fat-split { margin-top: 4px; }
  .fat-split-track {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    display: flex;
  }
  .fat-split-sat   { height: 100%; background: #e05858; border-radius: 2px 0 0 2px; transition: width 0.5s cubic-bezier(0.4,0,0.2,1); }
  .fat-split-unsat { height: 100%; background: #60c060; transition: width 0.5s cubic-bezier(0.4,0,0.2,1); }
  .fat-split-legend {
    display: flex;
    gap: 12px;
    margin-top: 4px;
    font-size: 0.65rem;
  }
  .fat-split-sat-label   { color: #e05858; }
  .fat-split-unsat-label { color: #60c060; }


  .bar-chart { display: flex; flex-direction: column; gap: 18px; }
  .bar-row { display: flex; flex-direction: column; gap: 6px; }

  .bar-row-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 6px;
  }

  .bar-label {
    font-size: 0.62rem;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }

  .bar-value {
    font-family: 'Fraunces', serif;
    font-size: 0.95rem;
    font-weight: 600;
    line-height: 1;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .bar-track {
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
  }

  .bar-fill {
    height: 100%;
    border-radius: 3px;
    width: 0%;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Macro chart colours */
  .bar-row.protein .bar-label, .bar-row.protein .bar-value { color: var(--protein); }
  .bar-row.protein .bar-fill { background: var(--protein); }
  .bar-row.carbs .bar-label, .bar-row.carbs .bar-value { color: var(--carbs); }
  .bar-row.carbs .bar-fill { background: var(--carbs); }
  .bar-row.fat .bar-label, .bar-row.fat .bar-value { color: var(--fat); }
  .bar-row.fat .bar-fill { background: var(--fat); }
  .bar-row.fibre .bar-label, .bar-row.fibre .bar-value { color: var(--fibre); }
  .bar-row.fibre .bar-fill { background: var(--fibre); }
  .bar-row.calories .bar-label, .bar-row.calories .bar-value { color: var(--cal); }
  .bar-row.calories .bar-fill { background: var(--cal); }

  .chart-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 14px 0;
  }

  /* Vitamin chart — colour palette cycling */
  .vit-section-label {
    font-size: 0.58rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin: 14px 0 8px;
  }
  .vit-section-label:first-of-type { margin-top: 0; }

  /* Each vitamin bar gets a colour from a CSS custom property set inline */
  .vit-bar .bar-label, .vit-bar .bar-value { color: var(--vit-color, var(--vit)); }
  .vit-bar .bar-fill { background: var(--vit-color, var(--vit)); }

  /* RDA indicator dot */
  .bar-rda-wrap {
    position: relative;
  }
  .bar-track-rda {
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: visible;
    position: relative;
  }

  /* Food log */
  .food-list-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .food-list-title {
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
  }
  .clear-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 4px 10px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.08em;
  }
  .clear-btn:hover { border-color: var(--protein); color: var(--protein); }

  .food-list { display: flex; flex-direction: column; gap: 8px; }

  .food-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 18px;
    animation: fadeIn 0.3s ease;
    transition: border-color 0.15s;
  }
  .food-item:hover { border-color: #3a3b36; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .food-item-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .food-name { font-size: 0.85rem; color: var(--text); }
  .food-name small { display: block; color: var(--muted); font-size: 0.7rem; margin-top: 2px; }

  .food-item-macros {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
  }

  .macro-box {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: border-color 0.15s;
    cursor: text;
  }
  .macro-box:focus-within { border-color: currentColor; }
  .macro-box.p   { color: var(--protein); }
  .macro-box.c   { color: var(--carbs); }
  .macro-box.f   { color: var(--fat); }
  .macro-box.fb  { color: var(--fibre); }
  .macro-box.kcal{ color: var(--cal); }

  .macro-box-label {
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    pointer-events: none;
  }
  .macro-box input.macro-input {
    background: transparent;
    border: none;
    color: inherit;
    font-family: 'Fraunces', serif;
    font-size: 1.3rem;
    font-weight: 600;
    width: 100%;
    outline: none;
    padding: 0;
    text-align: center;
    line-height: 1;
  }
  .macro-box-unit { font-size: 0.6rem; color: var(--muted); pointer-events: none; }

  .macro-input::-webkit-outer-spin-button,
  .macro-input::-webkit-inner-spin-button { -webkit-appearance: none; }
  .macro-input[type=number] { -moz-appearance: textfield; }

  .delete-btn {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 2px 4px;
    font-size: 0.8rem;
    transition: color 0.15s;
    line-height: 1;
    flex-shrink: 0;
  }
  .delete-btn:hover { color: var(--protein); }

  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--muted);
    font-size: 0.8rem;
    border: 1px dashed var(--border);
    border-radius: 8px;
  }
  .empty-state .hint {
    display: block;
    margin-top: 8px;
    font-size: 0.7rem;
    opacity: 0.6;
  }

  /* Vitamin chart scrollable if long */
  .vit-chart-scroll {
    max-height: 70vh;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  @media (max-width: 480px) {
    .charts-row { grid-template-columns: 1fr; }
    .food-item-macros { grid-template-columns: repeat(3, 1fr); }
  }
  @media (max-width: 420px) {
    .food-item-macros { grid-template-columns: repeat(2, 1fr); }
  }

  /* Recommendations */
  .rec-section {
    margin-top: 32px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 28px;
  }

  .rec-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 24px;
  }

  .rec-title {
    font-family: 'Fraunces', serif;
    font-size: 1.2rem;
    font-weight: 300;
    color: var(--text);
    letter-spacing: -0.01em;
  }

  .rec-subtitle {
    font-size: 0.7rem;
    color: var(--muted);
    margin-top: 4px;
    letter-spacing: 0.04em;
  }

  .rec-btn {
    background: transparent;
    border: 1px solid var(--accent);
    border-radius: 6px;
    padding: 10px 18px;
    color: var(--accent);
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    flex-shrink: 0;
    letter-spacing: 0.05em;
  }
  .rec-btn:hover { background: var(--accent); color: var(--bg); }
  .rec-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .rec-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
  }

  .rec-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 18px;
    animation: fadeIn 0.4s ease both;
  }
  .rec-card:nth-child(2) { animation-delay: 0.08s; }
  .rec-card:nth-child(3) { animation-delay: 0.16s; }

  .rec-card-num {
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 6px;
  }

  .rec-card-food {
    font-family: 'Fraunces', serif;
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 8px;
    line-height: 1.2;
  }

  .rec-card-why {
    font-size: 0.72rem;
    color: var(--text);
    line-height: 1.6;
    margin-bottom: 12px;
    opacity: 0.85;
  }

  .rec-card-nutrients {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }

  .rec-nutrient-tag {
    font-size: 0.62rem;
    padding: 2px 7px;
    border-radius: 20px;
    background: rgba(255,255,255,0.06);
    color: var(--muted);
    letter-spacing: 0.04em;
  }

  .rec-loading {
    grid-column: 1 / -1;
    text-align: center;
    padding: 32px;
    color: var(--muted);
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .rec-loading::before {
    content: '';
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 720px) {
    .rec-cards { grid-template-columns: 1fr; }
    .rec-header { flex-direction: column; }
  }

  

  /* Tooltip icon */
  .tip-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 1px solid var(--muted);
    color: var(--muted);
    font-size: 9px;
    font-style: normal;
    cursor: pointer;
    margin-left: 5px;
    flex-shrink: 0;
    vertical-align: middle;
    transition: all 0.15s;
  }
  .tip-icon:hover { background: var(--surface); }

  /* Modal overlay */
  #tipModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }
  #tipModal.open { display: flex; }
  #tipModal .tip-box {
    background: #1e1f1a;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px 28px;
    max-width: 340px;
    width: 90%;
    box-shadow: 0 16px 48px rgba(0,0,0,0.7);
  }
  #tipModal .tip-box h3 {
    font-family: 'Fraunces', serif;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--accent);
  }
  #tipModal .tip-box p {
    font-size: 0.78rem;
    line-height: 1.65;
    color: var(--text);
    opacity: 0.9;
  }
  #tipModal .tip-close {
    margin-top: 18px;
    display: block;
    width: 100%;
    padding: 9px;
    background: var(--border);
    border: none;
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    cursor: pointer;
    transition: background 0.15s;
  }
  #tipModal .tip-close:hover { background: #3a3b36; }


  /* Tabs */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 32px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0;
  }
  .tab-btn {
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    padding: 8px 18px 10px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.15s;
    margin-bottom: -1px;
  }
  .tab-btn:hover { color: var(--text); }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* Tab panels */
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* New day button */
  .new-day-btn {
    background: none;
    border: 1px solid var(--accent);
    border-radius: 6px;
    padding: 8px 16px;
    color: var(--accent);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.05em;
    white-space: nowrap;
  }
  .new-day-btn:hover { background: var(--accent); color: var(--bg); }

  /* Header row with title + new day btn */
  .header-row {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 8px;
  }

  /* History */
  .history-empty {
    text-align: center;
    padding: 60px 24px;
    color: var(--muted);
    font-size: 0.8rem;
    border: 1px dashed var(--border);
    border-radius: 8px;
  }

  .history-edit-date-btn {
    background: none; border: 1px solid var(--border); color: var(--muted); font-size: 11px;
    cursor: pointer; padding: 2px 7px; border-radius: 4px; transition: all 0.15s;
    line-height: 1.4; font-family: 'DM Mono', monospace;
  }
  .history-edit-date-btn:hover { opacity: 1; color: var(--accent); border-color: var(--accent); }

    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 16px;
    overflow: hidden;
  }

  .history-day-header {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 16px 20px;
    cursor: pointer;
    user-select: none;
    transition: background 0.15s;
  }
  .history-day-header:hover { background: rgba(255,255,255,0.02); }

  .history-day-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .history-day-date {
    font-family: 'Fraunces', serif;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
  }

  .history-day-summary {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    flex-wrap: wrap;
  }

  .history-macro-badge {
    font-size: 0.68rem;
    padding: 3px 8px;
    border-radius: 20px;
  }
  .history-macro-badge.p  { background: rgba(240,96,96,0.12);  color: var(--protein); }
  .history-macro-badge.c  { background: rgba(240,160,48,0.12); color: var(--carbs); }
  .history-macro-badge.f  { background: rgba(200,240,96,0.12); color: var(--fat); }
  .history-macro-badge.k  { background: rgba(160,96,240,0.12); color: var(--cal); }

  .history-chevron {
    color: var(--muted);
    font-size: 0.7rem;
    transition: transform 0.2s;
    flex-shrink: 0;
  }
  .history-day.open .history-chevron { transform: rotate(180deg); }

  .history-day-foods {
    display: none;
    border-top: 1px solid var(--border);
    padding: 12px 20px 16px;
  }
  .history-day.open .history-day-foods { display: block; }

  .history-food-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.78rem;
    gap: 12px;
  }
  .history-food-row:last-child { border-bottom: none; }
  .history-food-name { color: var(--text); flex: 1; }
  .history-food-macros { display: flex; gap: 8px; flex-shrink: 0; }
  .history-food-macros span { font-size: 0.68rem; color: var(--muted); }

  .history-delete-btn {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 0.7rem;
    padding: 2px 4px;
    transition: color 0.15s;
    flex-shrink: 0;
  }
  .history-delete-btn:hover { color: var(--protein); }


  /* Confirm modal */
  #confirmModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }
  #confirmModal.open { display: flex; }
  #confirmModal .confirm-box {
    background: #1e1f1a;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 28px;
    max-width: 360px;
    width: 90%;
    box-shadow: 0 16px 48px rgba(0,0,0,0.7);
  }
  #confirmModal .confirm-msg {
    font-size: 0.88rem;
    color: var(--text);
    line-height: 1.6;
    margin-bottom: 22px;
  }
  #confirmModal .confirm-msg strong {
    display: block;
    font-family: 'Fraunces', serif;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 6px;
  }
  #confirmModal .confirm-btns {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  #confirmModal .confirm-cancel {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 9px 20px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  #confirmModal .confirm-cancel:hover { border-color: var(--text); color: var(--text); }
  #confirmModal .confirm-ok {
    background: var(--accent);
    border: none;
    border-radius: 6px;
    padding: 9px 20px;
    color: var(--bg);
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }
  #confirmModal .confirm-ok:hover { background: #d4f572; }


  /* History trend chart */
  .history-charts-row {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
  }
  .history-chart-subtitle {
    font-size: 0.6rem;
    color: var(--muted);
    letter-spacing: 0.08em;
  }
  /* History trend chart */
  .history-chart-panel canvas { width: 100%; display: block; }
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .history-chart-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .history-chart-title {
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .history-chart-legend {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.06em;
    cursor: pointer;
    user-select: none;
    transition: opacity 0.15s;
  }

  .legend-item.hidden { opacity: 0.3; }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  #historyCanvas {
    width: 100%;
    display: block;
    border-radius: 4px;
  }


  /* Top gaps heatmap */
  .heatmap-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 4px;
  }
  .heatmap-table th {
    font-size: 0.58rem;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: var(--muted);
    font-weight: 400;
    padding: 0 6px 8px;
    text-align: center;
    white-space: nowrap;
  }
  .heatmap-table th.nutrient-col {
    text-align: left;
    padding-left: 0;
    min-width: 90px;
  }
  .heatmap-table td {
    padding: 4px 4px;
    text-align: center;
  }
  .heatmap-table td.nutrient-name {
    font-size: 0.65rem;
    color: var(--text);
    text-align: left;
    padding-left: 0;
    padding-right: 8px;
    white-space: nowrap;
  }
  .heatmap-cell {
    display: inline-block;
    width: 32px;
    height: 24px;
    border-radius: 4px;
    line-height: 24px;
    font-size: 0.6rem;
    color: rgba(255,255,255,0.7);
    font-variant-numeric: tabular-nums;
  }
  .heatmap-avg-col {
    font-size: 0.65rem;
    font-family: 'Fraunces', serif;
    font-weight: 600;
    padding-left: 8px !important;
  }


  /* Nutrient breakdown panel */
  .bar-row { cursor: pointer; }
  .bar-row:hover .bar-label { opacity: 0.8; }

  .breakdown-panel {
    display: none;
    margin-top: 8px;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    padding: 10px 12px;
    gap: 5px;
    flex-direction: column;
  }
  .breakdown-panel.open { display: flex; }

  .breakdown-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.68rem;
  }
  .breakdown-food-name {
    flex: 1;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }
  .breakdown-bar-track {
    flex: 2;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .breakdown-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.4s ease;
  }
  .breakdown-amount {
    color: var(--muted);
    white-space: nowrap;
    flex-shrink: 0;
    min-width: 48px;
    text-align: right;
  }
  .breakdown-zero { opacity: 0.3; }


  /* Inline nutrient value editing in breakdown */
  .breakdown-amount {
    position: relative;
  }
  .breakdown-amount-btn {
    background: none;
    border: none;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    cursor: pointer;
    padding: 1px 4px;
    border-radius: 3px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .breakdown-amount-btn:hover {
    background: rgba(200,240,96,0.12);
    color: var(--accent);
  }
  .breakdown-inline-edit {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .breakdown-inline-input {
    width: 52px;
    background: var(--bg);
    border: 1px solid var(--accent);
    border-radius: 4px;
    padding: 2px 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    outline: none;
    text-align: right;
  }
  .breakdown-inline-save {
    background: var(--accent);
    border: none;
    border-radius: 3px;
    padding: 2px 6px;
    color: var(--bg);
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    cursor: pointer;
    font-weight: 500;
  }
  .breakdown-inline-cancel {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 0.65rem;
    cursor: pointer;
    padding: 1px 3px;
  }


  /* Food memory */
  .memory-badge {
    display: inline-block;
    font-size: 0.58rem;
    letter-spacing: 0.06em;
    background: rgba(200,240,96,0.1);
    color: var(--accent);
    border: 1px solid rgba(200,240,96,0.2);
    border-radius: 10px;
    padding: 1px 7px;
    margin-left: 6px;
    vertical-align: middle;
    opacity: 0.8;
  }


  /* ── Ask Tab ────────────────────────────────────────────────────────── */
  #tab-ask.active {
    display: flex !important;
    flex-direction: column;
    height: 600px;
  }
  .ask-context-bar {
    font-size: 11px; color: var(--muted); background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 14px; margin-bottom: 16px; line-height: 1.5; flex-shrink: 0;
  }
  .ask-messages {
    flex: 1; overflow-y: auto; display: flex; flex-direction: column;
    gap: 12px; margin-bottom: 16px; padding-right: 4px; min-height: 0;
  }
  .ask-empty {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; flex: 1; gap: 10px; color: var(--muted); text-align: center;
  }
  .ask-empty-icon { font-size: 28px; color: var(--accent); opacity: 0.6; }
  .ask-empty-title { font-size: 15px; color: var(--text); font-weight: 500; }
  .ask-empty-sub { font-size: 12px; max-width: 380px; line-height: 1.6; }
  .ask-suggestions { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 8px; }
  .ask-suggestion {
    background: var(--surface); border: 1px solid var(--border); color: var(--muted);
    font-family: 'DM Mono', monospace; font-size: 11px; padding: 7px 12px;
    border-radius: 20px; cursor: pointer; transition: all 0.15s;
  }
  .ask-suggestion:hover { border-color: var(--accent); color: var(--accent); }
  .ask-bubble {
    max-width: 85%; padding: 12px 16px; border-radius: 12px;
    font-size: 13px; line-height: 1.65; white-space: pre-wrap;
  }
  .ask-bubble.user { align-self: flex-end; background: var(--accent); color: #0e0f0c; border-bottom-right-radius: 3px; }
  .ask-bubble.assistant { align-self: flex-start; background: var(--surface); border: 1px solid var(--border); color: var(--text); border-bottom-left-radius: 3px; }
  .ask-bubble.thinking { align-self: flex-start; background: var(--surface); border: 1px solid var(--border); color: var(--muted); font-style: italic; border-bottom-left-radius: 3px; }
  .ask-input-row { display: flex; gap: 10px; flex-shrink: 0; }
  .ask-input {
    flex: 1; background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px;
    padding: 12px 16px; border-radius: 10px; outline: none; transition: border-color 0.15s;
  }
  .ask-input:focus { border-color: var(--accent); }
  .ask-send-btn {
    background: var(--accent); color: #0e0f0c; border: none;
    font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500;
    padding: 12px 22px; border-radius: 10px; cursor: pointer; transition: opacity 0.15s;
  }
  .ask-send-btn:hover { opacity: 0.85; }
  .ask-send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ── Goals Tab ──────────────────────────────────────────────────────── */
  .goals-header { margin-bottom: 28px; }
  .goals-title { font-family: 'Fraunces', serif; font-size: 1.6rem; font-weight: 300; color: var(--accent); margin-bottom: 6px; }
  .goals-sub { font-size: 12px; color: var(--muted); line-height: 1.5; }
  .goals-section-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 12px; }
  .goals-grid { display: flex; flex-direction: column; gap: 10px; max-width: 420px; margin-bottom: 28px; }
  .goals-row {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px 18px;
  }
  .goals-label { font-size: 13px; color: var(--text); }
  .goals-input-wrap { display: flex; align-items: center; gap: 8px; }
  .goals-input {
    background: var(--bg); border: 1px solid var(--border); color: var(--accent);
    font-family: 'DM Mono', monospace; font-size: 15px; font-weight: 500;
    width: 80px; padding: 6px 10px; border-radius: 6px; text-align: right; outline: none;
  }
  .goals-input:focus { border-color: var(--accent); }
  .goals-unit { font-size: 12px; color: var(--muted); width: 28px; }
  .goals-actions { display: flex; gap: 12px; align-items: center; }
  .goals-save-btn {
    background: var(--accent); color: #0e0f0c; border: none;
    font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500;
    padding: 12px 24px; border-radius: 10px; cursor: pointer; transition: opacity 0.15s;
  }
  .goals-save-btn:hover { opacity: 0.85; }
  .goals-reset-btn {
    background: transparent; color: var(--muted); border: 1px solid var(--border);
    font-family: 'DM Mono', monospace; font-size: 12px; padding: 12px 20px;
    border-radius: 10px; cursor: pointer; transition: all 0.15s;
  }
  .goals-reset-btn:hover { color: var(--text); border-color: var(--text); }

  .goals-advanced {
    margin-bottom: 24px;
    max-width: 420px;
  }
  .goals-advanced-toggle {
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 0;
    user-select: none;
  }
  .goals-advanced-toggle::-webkit-details-marker { display: none; }
  .goals-advanced-toggle::before {
    content: '▸';
    font-size: 10px;
    transition: transform 0.2s;
  }
  details.goals-advanced[open] .goals-advanced-toggle::before {
    transform: rotate(90deg);
  }
  .goals-advanced-toggle:hover { color: var(--text); }
  .goals-advanced-note { opacity: 0.6; }
  .goals-advanced-body { padding-top: 10px; }

  .goals-toggle-group { display: flex; gap: 6px; }
  .goals-toggle {
    background: var(--bg); border: 1px solid var(--border); color: var(--muted);
    font-family: 'DM Mono', monospace; font-size: 12px; padding: 6px 14px;
    border-radius: 6px; cursor: pointer; transition: all 0.15s;
  }
  .goals-toggle:hover { border-color: var(--text); color: var(--text); }
  .goals-toggle.active { background: var(--accent); border-color: var(--accent); color: #0e0f0c; }
  .goals-saved-msg { margin-top: 14px; font-size: 12px; color: var(--accent); min-height: 18px; }
</style>
</head>
<body>
<div id="confirmModal">
  <div class="confirm-box">
    <div class="confirm-msg" id="confirmMsg"></div>
    <div class="confirm-btns">
      <button class="confirm-cancel" onclick="resolveConfirm(false)">Cancel</button>
      <button class="confirm-ok" id="confirmOkBtn" onclick="resolveConfirm(true)">Confirm</button>
    </div>
  </div>
</div>
<div id="tipModal" onclick="closeTipModal()">
  <div class="tip-box" onclick="event.stopPropagation()">
    <h3 id="tipModalTitle"></h3>
    <p id="tipModalBody"></p>
    <button class="tip-close" onclick="closeTipModal()">Close</button>
  </div>
</div>
<div class="container">
  <header>
    <div class="header-row">
      <div>
        <h1>Mango<em>Track</em></h1>
        <p class="subtitle">AI-powered daily nutrition log</p>
      </div>
      <button class="new-day-btn" onclick="newDay()">⊕ New Day</button>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('today', this)">Today</button>
    <button class="tab-btn" onclick="switchTab('history', this)">History</button>
    <button class="tab-btn" onclick="switchTab('ask', this)">Ask</button>
    <button class="tab-btn" onclick="switchTab('goals', this)">Goals</button>
  </div>

  <!-- TODAY TAB -->
  <div class="tab-panel active" id="tab-today">

  <div class="input-row">
    <input type="text" id="mangoFoodInput" placeholder='e.g. "2 eggs and toast" or "large chicken caesar salad"' onkeydown="if(event.key==='Enter')addFood()" />
    <button class="add-btn" id="mangoAddBtn" onclick="addFood()">+ Add</button>
  </div>

  <div class="loading-bar" id="loadingBar"></div>
  <div class="error-toast" id="errorToast"></div>

  <!-- Two charts side by side -->
  <div class="charts-row">

    <!-- Left: Macro chart -->
    <div class="chart-panel">
      <div class="chart-panel-title">Today's Macros</div>
      <div class="bar-chart">
        <div class="bar-row protein" onclick="toggleBreakdown('protein','g')">
          <div class="bar-row-header"><span class="bar-label">Protein</span><span class="bar-value" id="totalProtein">0g</span></div>
          <div class="bar-track"><div class="bar-fill" id="barProtein"></div></div>
          <div class="breakdown-panel" id="bd-protein"></div>
        </div>
        <div class="bar-row carbs" onclick="toggleBreakdown('carbs','g')">
          <div class="bar-row-header"><span class="bar-label">Carbs</span><span class="bar-value" id="totalCarbs">0g</span></div>
          <div class="bar-track"><div class="bar-fill" id="barCarbs"></div></div>
          <div class="breakdown-panel" id="bd-carbs"></div>
        </div>
        <div class="bar-row fat" onclick="toggleBreakdown('fat','g')">
          <div class="bar-row-header"><span class="bar-label">Fat</span><span class="bar-value" id="totalFat">0g</span></div>
          <div class="bar-track"><div class="bar-fill" id="barFat"></div></div>
          <div class="breakdown-panel" id="bd-fat"></div>
          <div class="fat-split" id="fatSplitBar" style="display:none"></div>
        </div>
        <div class="bar-row fibre" onclick="toggleBreakdown('fibre','g')">
          <div class="bar-row-header"><span class="bar-label">Fibre</span><span class="bar-value" id="totalFibre">0g</span></div>
          <div class="bar-track"><div class="bar-fill" id="barFibre"></div></div>
          <div class="breakdown-panel" id="bd-fibre"></div>
        </div>
        <hr class="chart-divider">
        <div class="bar-row calories" onclick="toggleBreakdown('calories','kcal')">
          <div class="bar-row-header"><span class="bar-label">Calories</span><span class="bar-value" id="totalCal">0 kcal</span></div>
          <div class="bar-track"><div class="bar-fill" id="barCal"></div></div>
          <div class="breakdown-panel" id="bd-calories"></div>
        </div>
      </div>
    </div>

    <!-- Right: Vitamins & Minerals chart -->
    <div class="chart-panel vit-panel">
      <div class="chart-panel-title">Vitamins &amp; Minerals</div>
      <div class="vit-chart-scroll">
        <div class="bar-chart" id="vitChart">
          <div style="color:var(--muted);font-size:0.75rem;text-align:center;padding:32px 0;opacity:0.5;">Add food to see vitamins &amp; minerals</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Food log — full width below charts -->
  <div class="log-section">
    <div class="food-list-header">
      <span class="food-list-title">Today's Log</span>
      <button class="clear-btn" onclick="clearAll()">Clear All</button>
    </div>
    <div class="empty-state" id="emptyState">
      No food logged yet
      <span class="hint">Type anything natural — "3 slices of pizza" or "bowl of oatmeal with banana"</span>
    </div>
    <div class="food-list" id="foodList"></div>
  </div>

  <!-- Recommendations -->
  <div class="rec-section" id="recSection" style="display:none">
    <div class="rec-header">
      <div>
        <div class="rec-title">Smart Food Recommendations</div>
        <div class="rec-subtitle">3 foods to most efficiently fill your micronutrient gaps today</div>
      </div>
      <button class="rec-btn" id="recBtn" onclick="getRecommendations()">
        <span id="recBtnText">✦ Suggest Foods</span>
      </button>
    </div>
    <div class="rec-cards" id="recCards"></div>
  </div>

  </div><!-- /tab-today -->

  <!-- HISTORY TAB -->
  <div class="tab-panel" id="tab-history">
    <div id="historyChartPanel" style="display:none">
      <div class="history-charts-row">
        <div class="history-chart-panel">
          <div class="history-chart-header">
            <span class="history-chart-title" style="color:var(--protein)">Protein</span>
            <span class="history-chart-subtitle">grams per day</span>
          </div>
          <canvas id="historyCanvasProtein" height="180"></canvas>
        </div>
        <div class="history-chart-panel">
          <div class="history-chart-header">
            <span class="history-chart-title" style="color:var(--cal)">Calories</span>
            <span class="history-chart-subtitle">kcal per day</span>
          </div>
          <canvas id="historyCanvasCalories" height="180"></canvas>
        </div>
        <div class="history-chart-panel">
          <div class="history-chart-header">
            <span class="history-chart-title" style="color:var(--vit)">Micronutrient Score</span>
            <span class="history-chart-subtitle">avg % of RDA across all vitamins &amp; minerals</span>
          </div>
          <canvas id="historyCanvasVitScore" height="180"></canvas>
        </div>
        <div class="history-chart-panel" id="topGapsPanel">
          <div class="history-chart-header">
            <span class="history-chart-title" style="color:var(--muted)">Chronic Gaps</span>
            <span class="history-chart-subtitle">your 5 most consistently under-filled nutrients</span>
          </div>
          <div id="topGapsHeatmap"></div>
        </div>
      </div>
    </div>
    <div id="historyList"></div>
  </div>

  <!-- ASK TAB -->
  <div class="tab-panel" id="tab-ask">
    <div class="ask-context-bar" id="askContextBar"></div>
    <div class="ask-messages" id="askMessages">
      <div class="ask-empty">
        <div class="ask-empty-icon">✦</div>
        <div class="ask-empty-title">Nutrition Assistant</div>
        <div class="ask-empty-sub">Ask anything about nutrition. I know what you've eaten today and your current nutrient gaps.</div>
        <div class="ask-suggestions">
          <button class="ask-suggestion" onclick="askSuggestion(this)">What foods are high in selenium?</button>
          <button class="ask-suggestion" onclick="askSuggestion(this)">Am I getting enough protein today?</button>
          <button class="ask-suggestion" onclick="askSuggestion(this)">What should I eat for dinner to fill my gaps?</button>
          <button class="ask-suggestion" onclick="askSuggestion(this)">Explain the difference between B6 and B12</button>
        </div>
      </div>
    </div>
    <div class="ask-input-row">
      <input type="text" id="askInput" class="ask-input" placeholder="Ask about nutrition…" onkeydown="if(event.key==='Enter')sendAsk()" />
      <button class="ask-send-btn" id="askSendBtn" onclick="sendAsk()">Ask</button>
    </div>
  </div>

  <!-- GOALS TAB -->
  <div class="tab-panel" id="tab-goals">
    <div class="goals-header">
      <div class="goals-title">Daily Goals</div>
      <div class="goals-sub">Set your personal targets. These are used for all progress bars and history charts.</div>
    </div>
    <div class="goals-section-label">Macros</div>
    <div class="goals-grid">
      <div class="goals-row">
        <label class="goals-label">Protein</label>
        <div class="goals-input-wrap"><input type="number" class="goals-input" id="goalProtein" oninput="showGoalsActions()" /><span class="goals-unit">g</span></div>
      </div>
      <div class="goals-row">
        <label class="goals-label">Carbohydrates</label>
        <div class="goals-input-wrap"><input type="number" class="goals-input" id="goalCarbs" oninput="showGoalsActions()" /><span class="goals-unit">g</span></div>
      </div>
      <div class="goals-row">
        <label class="goals-label">Fat</label>
        <div class="goals-input-wrap"><input type="number" class="goals-input" id="goalFat" oninput="showGoalsActions()" /><span class="goals-unit">g</span></div>
      </div>
      <div class="goals-row">
        <label class="goals-label">Fibre</label>
        <div class="goals-input-wrap"><input type="number" class="goals-input" id="goalFibre" oninput="showGoalsActions()" /><span class="goals-unit">g</span></div>
      </div>
      <div class="goals-row">
        <label class="goals-label">Calories</label>
        <div class="goals-input-wrap"><input type="number" class="goals-input" id="goalCalories" oninput="showGoalsActions()" /><span class="goals-unit">kcal</span></div>
      </div>
    </div>
    <div class="goals-actions" id="goalsActions" style="display:none">
      <button class="goals-save-btn" onclick="saveGoals()">Save Goals</button>
      <button class="goals-reset-btn" onclick="resetGoals()">Reset to Defaults</button>
    </div>
    <div class="goals-saved-msg" id="goalsSavedMsg"></div>

    <details class="goals-advanced">
      <summary class="goals-advanced-toggle">Profile settings <span class="goals-advanced-note">— adjusts micronutrient RDAs</span></summary>
      <div class="goals-advanced-body">
        <div class="goals-grid" style="margin-bottom:0">
          <div class="goals-row">
            <label class="goals-label">Sex</label>
            <div class="goals-toggle-group" id="goalSexGroup">
              <button class="goals-toggle" data-val="male" onclick="toggleGoalOption('goalSexGroup',this)">Male</button>
              <button class="goals-toggle" data-val="female" onclick="toggleGoalOption('goalSexGroup',this)">Female</button>
            </div>
          </div>
          <div class="goals-row">
            <label class="goals-label">Age bracket</label>
            <div class="goals-toggle-group" id="goalAgeGroup">
              <button class="goals-toggle" data-val="18-50" onclick="toggleGoalOption('goalAgeGroup',this)">18–50</button>
              <button class="goals-toggle" data-val="51-70" onclick="toggleGoalOption('goalAgeGroup',this)">51–70</button>
              <button class="goals-toggle" data-val="70+" onclick="toggleGoalOption('goalAgeGroup',this)">70+</button>
            </div>
          </div>
        </div>
      </div>
    </details>
  </div>

</div>

<script>
// ─── Vitamin/mineral config: key, display label, RDA, unit, colour ───────────
const VIT_META = [
  // Vitamins
  { key:'vitA',   label:'Vitamin A',    rda:700,  unit:'mcg', color:'#f0c060', section:'Vitamins',  tip:'Essential for vision, immune defence, and skin cell turnover. Also supports reproductive health and fetal development.' },
  { key:'vitC',   label:'Vitamin C',    rda:90,   unit:'mg',  color:'#f08040', section:'Vitamins',  tip:'A powerful antioxidant that builds collagen, boosts immune function, aids iron absorption, and speeds wound healing.' },
  { key:'vitD',   label:'Vitamin D',    rda:20,   unit:'mcg', color:'#f0e060', section:'Vitamins',  tip:'Regulates calcium for strong bones and teeth. Also modulates immune response, mood, and may reduce depression risk.' },
  { key:'vitE',   label:'Vitamin E',    rda:15,   unit:'mg',  color:'#d0a040', section:'Vitamins',  tip:'Fat-soluble antioxidant that protects cell membranes from oxidative damage. Supports immune function and skin health.' },
  { key:'vitK',   label:'Vitamin K',    rda:120,  unit:'mcg', color:'#a0d060', section:'Vitamins',  tip:'Critical for blood clotting and bone mineralisation. Vitamin K2 also helps direct calcium away from arteries.' },
  { key:'vitB1',  label:'B1 Thiamine',  rda:1.1,  unit:'mg',  color:'#80c080', section:'Vitamins',  tip:'Converts carbohydrates into energy and supports nerve function. Deficiency causes fatigue, nerve damage, and heart issues.' },
  { key:'vitB2',  label:'B2 Riboflavin',rda:1.1,  unit:'mg',  color:'#60d0a0', section:'Vitamins',  tip:'Drives energy metabolism and helps activate B6 and folate. Supports healthy skin, eyes, and red blood cell production.' },
  { key:'vitB3',  label:'B3 Niacin',    rda:14,   unit:'mg',  color:'#40c8c0', section:'Vitamins',  tip:'Key for energy production and DNA repair. Helps lower LDL cholesterol and supports brain function and skin integrity.' },
  { key:'vitB6',  label:'B6',           rda:1.7,  unit:'mg',  color:'#60b0f0', section:'Vitamins',  tip:'Involved in over 100 enzyme reactions including protein metabolism, neurotransmitter synthesis (serotonin, dopamine), and immune support.' },
  { key:'vitB12', label:'B12',          rda:2.4,  unit:'mcg', color:'#8080f0', section:'Vitamins',  tip:'Vital for red blood cell formation, DNA synthesis, and neurological function. Deficiency causes anaemia and nerve damage.' },
  { key:'folate', label:'Folate',       rda:400,  unit:'mcg', color:'#b060e0', section:'Vitamins',  tip:'Essential for DNA synthesis and cell division. Critically important in pregnancy to prevent neural tube defects.' },
  // Minerals
  { key:'calcium',   label:'Calcium',    rda:1000, unit:'mg',  color:'#f06090', section:'Minerals', tip:'The most abundant mineral in the body — builds bones and teeth, enables muscle contraction, nerve signalling, and blood clotting.' },
  { key:'iron',      label:'Iron',       rda:18,   unit:'mg',  color:'#e05050', section:'Minerals', tip:'Core component of haemoglobin that carries oxygen in blood. Deficiency is the leading cause of anaemia and fatigue worldwide.' },
  { key:'magnesium', label:'Magnesium',  rda:310,  unit:'mg',  color:'#f07040', section:'Minerals', tip:'Involved in 300+ enzymatic reactions. Regulates blood sugar, blood pressure, muscle and nerve function, and sleep quality.' },
  { key:'phosphorus',label:'Phosphorus', rda:700,  unit:'mg',  color:'#c0a050', section:'Minerals', tip:'Works with calcium to build bones and teeth. Also essential for energy storage (ATP), cell membrane structure, and kidney function.' },
  { key:'potassium', label:'Potassium',  rda:4700, unit:'mg',  color:'#80b050', section:'Minerals', tip:'Maintains fluid balance, nerve signals, and muscle contractions. High intake lowers blood pressure and reduces stroke risk.' },
  { key:'sodium',    label:'Sodium',     rda:2300, unit:'mg',  color:'#50b0a0', section:'Minerals', tip:'Regulates fluid balance and blood pressure. Essential for nerve and muscle function — but excess raises cardiovascular risk.' },
  { key:'zinc',      label:'Zinc',       rda:8,   unit:'mg',  color:'#50a0e0', section:'Minerals', tip:'Supports immune function, wound healing, protein synthesis, and DNA production. Also essential for taste, smell, and testosterone.' },
  { key:'selenium',  label:'Selenium',   rda:55,   unit:'mcg', color:'#7070d0', section:'Minerals', tip:'Powerful antioxidant that protects cells from damage. Supports thyroid hormone metabolism and reduces inflammation.' },
];


// Pre-escaped tip lookup to avoid attribute quoting issues
const VIT_TIPS = {};
VIT_META.forEach(m => { VIT_TIPS[m.key] = m.tip; });

const VIT_KEYS = VIT_META.map(v => v.key);

const DEFAULT_GOALS = { protein: 150, carbs: 250, fat: 70, fibre: 30, calories: 1750 };
const DEFAULT_PROFILE = { sex: 'male', age: '18-50' };
// Base VIT_META RDA values match female 18-50. Overrides applied on top.
const RDA_OVERRIDES = {
  'female:18-50': {},
  'female:51-70': { vitB6:1.5, vitD:20, iron:8, calcium:1200, magnesium:320 },
  'female:70+':   { vitB6:1.5, vitD:20, iron:8, calcium:1200, magnesium:320 },
  'male:18-50':   { vitA:900, vitB1:1.2, vitB2:1.3, vitB3:16, vitB6:1.3, iron:8, zinc:11, magnesium:400 },
  'male:51-70':   { vitA:900, vitB1:1.2, vitB2:1.3, vitB3:16, vitB6:1.7, vitD:20, iron:8, zinc:11, magnesium:420 },
  'male:70+':     { vitA:900, vitB1:1.2, vitB2:1.3, vitB3:16, vitB6:1.7, vitD:20, iron:8, calcium:1200, zinc:11, magnesium:420 },
};
// ─── Fix duplicate history dates ─────────────────────────────────────────────
(function fixDuplicateHistoryDates() {
  try {
    const history = JSON.parse(localStorage.getItem('mangotrack_history') || '[]');
    if (history.length < 2) return;
    let changed = false;
    for (let i = 1; i < history.length; i++) {
      // If this entry has the same ts date as the previous one, push it back by i days
      const prev = new Date(history[i-1].ts);
      const curr = new Date(history[i].ts);
      const prevDay = prev.toDateString();
      const currDay = curr.toDateString();
      if (prevDay === currDay) {
        // Offset this entry's ts back by 1 day per duplicate
        const fixed = new Date(history[i].ts);
        fixed.setDate(fixed.getDate() - 1);
        history[i].ts = fixed.getTime();
        // Also fix the date label
        history[i].date = fixed.toLocaleDateString('en-GB', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
        changed = true;
      }
    }
    if (changed) localStorage.setItem('mangotrack_history', JSON.stringify(history));
  } catch(e) {}
})();

let foods = JSON.parse(localStorage.getItem('macrotrack_foods') || '[]');
// Migrate old food entries that lack vit data
foods = foods.map(f => {
  VIT_KEYS.forEach(k => { if (f[k] === undefined) f[k] = 0; });
  return f;
});
renderAll();

// Enter key handled via onkeydown on foodInput directly


// ─── Food memory library ──────────────────────────────────────────────────────
// Normalise a food name to a lookup key: lowercase, strip quantities/units
function normaliseFoodKey(str) {
  return str.toLowerCase()
    .replace(/\d+(\.\d+)?\s*(g|kg|ml|l|oz|lb|cup|cups|tbsp|tsp|slice|slices|piece|pieces|serving|servings)?/g, '')
    .replace(/[^a-z\s]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

function loadMemory() {
  return JSON.parse(localStorage.getItem('mangotrack_memory') || '{}');
}

function saveToMemory(food) {
  const memory = loadMemory();
  const key = normaliseFoodKey(food.name);
  if (!key) return;
  // Store all nutritional fields (not id/query)
  const fields = ['name','serving','protein','carbs','fat','fibre','calories',...VIT_KEYS];
  const entry = {};
  fields.forEach(k => { entry[k] = food[k]; });
  entry.savedAt = Date.now();
  memory[key] = entry;
  localStorage.setItem('mangotrack_memory', JSON.stringify(memory));
}

function findInMemory(query) {
  const memory = loadMemory();
  const queryKey = normaliseFoodKey(query);
  if (!queryKey) return null;

  // Exact match first
  if (memory[queryKey]) return memory[queryKey];

  // Fuzzy: check if any stored key is contained in the query or vice versa
  const keys = Object.keys(memory);
  for (const k of keys) {
    if (queryKey.includes(k) || k.includes(queryKey)) {
      return memory[k];
    }
  }
  return null;
}

async function addFood() {
  const input = document.getElementById('mangoFoodInput');
  if (!input) return;
  const query = input.value.trim();
  if (!query) return;

  // Check memory first
  const memorised = findInMemory(query);
  if (memorised) {
    const food = {
      id: Date.now(),
      query,
      fromMemory: true,
      ...memorised,
    };
    VIT_KEYS.forEach(k => { if (food[k] === undefined) food[k] = 0; });
    foods.push(food);
    save();
    renderAll();
    input.value = '';
    return;
  }

  setLoading(true);
  hideError();
  try {
    const result = await fetchNutrition(query);
    foods.push(result);
    save();
    renderAll();
    input.value = '';
  } catch(e) {
    showError(e.message || 'Could not get nutrition data. Please try again.');
  } finally {
    setLoading(false);
  }
}

async function fetchNutrition(query) {
  const vitFields = VIT_KEYS.map(k => `  "${k}": <number in ${VIT_META.find(v=>v.key===k).unit}>`).join(',\n');

  const response = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      model: "claude-sonnet-4-6",
      max_tokens: 1500,
      system: `You are a nutrition database. When given a food description, return ONLY a valid JSON object (no markdown, no explanation) with these exact fields:
{
  "name": "short display name",
  "serving": "serving description",
  "protein": <grams>,
  "carbs": <grams>,
  "fat": <grams>,
  "fatSat": <grams of saturated fat>,
  "fatUnsat": <grams of unsaturated fat>,
  "fibre": <grams>,
  "calories": <kcal>,
${vitFields}
}
Use realistic average values for the given food and serving. Round all numbers to 1 decimal place maximum. Use 0 for trace amounts. fatSat + fatUnsat should equal fat.`,
      messages: [{ role: "user", content: query }]
    })
  });

  if (!response.ok) throw new Error('API request failed');
  const data = await response.json();
  const text = data.content.map(b => b.text || '').join('');
  let parsed;
  try {
    parsed = JSON.parse(text.replace(/```json|```/g, '').trim());
  } catch {
    throw new Error('Could not parse nutrition response');
  }

  const food = {
    id: Date.now(),
    query,
    name: parsed.name || query,
    serving: parsed.serving || '',
    protein:  round1(parsed.protein),
    carbs:    round1(parsed.carbs),
    fat:      round1(parsed.fat),
    fatSat:   round1(parsed.fatSat),
    fatUnsat: round1(parsed.fatUnsat),
    fibre:    round1(parsed.fibre),
    calories: Math.round(Number(parsed.calories) || 0),
  };
  VIT_KEYS.forEach(k => { food[k] = round1(parsed[k]); });
  return food;
}

function round1(v) { return Math.round(Number(v) * 10 || 0) / 10; }

// ─── Render ───────────────────────────────────────────────────────────────────

function renderAll() {
  renderList();
  renderTotals();
  renderVitChart();
  maybeShowRec();
}

function renderList() {
  const list  = document.getElementById('foodList');
  const empty = document.getElementById('emptyState');
  if (foods.length === 0) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  list.innerHTML = foods.map(f => `
    <div class="food-item" id="item-${f.id}">
      <div class="food-item-top">
        <div class="food-name">${escHtml(f.name)}${f.fromMemory ? '<span class="memory-badge">remembered</span>' : ''}<small>${escHtml(f.serving)}</small></div>
        <button class="delete-btn" onclick="removeFood(${f.id})" title="Remove">✕</button>
      </div>

      <div class="food-item-macros">
        <div class="macro-box p">
          <span class="macro-box-label">Protein</span>
          <input class="macro-input" type="number" min="0" step="0.1" value="${f.protein}" onchange="updateMacro(${f.id},'protein',this.value)" onblur="updateMacro(${f.id},'protein',this.value)" />
          <span class="macro-box-unit">grams</span>
        </div>
        <div class="macro-box c">
          <span class="macro-box-label">Carbs</span>
          <input class="macro-input" type="number" min="0" step="0.1" value="${f.carbs}" onchange="updateMacro(${f.id},'carbs',this.value)" onblur="updateMacro(${f.id},'carbs',this.value)" />
          <span class="macro-box-unit">grams</span>
        </div>
        <div class="macro-box f">
          <span class="macro-box-label">Fat</span>
          <input class="macro-input" type="number" min="0" step="0.1" value="${f.fat}" onchange="updateMacro(${f.id},'fat',this.value)" onblur="updateMacro(${f.id},'fat',this.value)" />
          <span class="macro-box-unit">grams</span>
        </div>
        <div class="macro-box fb">
          <span class="macro-box-label">Fibre</span>
          <input class="macro-input" type="number" min="0" step="0.1" value="${f.fibre}" onchange="updateMacro(${f.id},'fibre',this.value)" onblur="updateMacro(${f.id},'fibre',this.value)" />
          <span class="macro-box-unit">grams</span>
        </div>
        <div class="macro-box kcal">
          <span class="macro-box-label">Calories</span>
          <input class="macro-input" type="number" min="0" value="${f.calories}" onchange="updateMacro(${f.id},'calories',this.value)" onblur="updateMacro(${f.id},'calories',this.value)" />
          <span class="macro-box-unit">kcal</span>
        </div>
      </div>
    </div>
  `).join('');
}


// ─── History trend chart ──────────────────────────────────────────────────────
function drawHistoryChart() {
  const history = JSON.parse(localStorage.getItem('mangotrack_history') || '[]');
  if (history.length === 0) return;

  // Oldest first
  const days = [...history].reverse();
  const data = days.map(day => {
    const t = day.foods.reduce((a, f) => {
      const row = { protein: a.protein + (f.protein||0), calories: a.calories + (f.calories||0) };
      VIT_KEYS.forEach(k => { row[k] = (a[k]||0) + (f[k]||0); });
      return row;
    }, { protein:0, calories:0 });
    // Compute micronutrient score: avg % RDA across all nutrients
    const pcts = VIT_META.map(m => Math.min(100, (t[m.key] / m.rda) * 100));
    t.vitScore = Math.round(pcts.reduce((s,v) => s+v, 0) / pcts.length);
    // Store per-nutrient pcts for heatmap
    t.vitPcts = {};
    VIT_META.forEach((m, i) => { t.vitPcts[m.key] = pcts[i]; });
    const d = new Date(day.ts);
    // Use month + day number — always unique, never duplicates
    // day.date is like "Thursday, 26 February 2026" — extract day + month
    let label;
    if (day.date) {
      const parts = day.date.split(', ');
      if (parts[1]) {
        const dateParts = parts[1].split(' ');
        const dayNum = dateParts[0];
        const month = dateParts[1] ? dateParts[1].slice(0, 3) : '';
        label = dayNum + ' ' + month;
      } else {
        label = d.toLocaleDateString('en-GB', { day:'numeric', month:'short' });
      }
    } else {
      label = d.toLocaleDateString('en-GB', { day:'numeric', month:'short' });
    }
    t.label = label;
    return t;
  });

  drawSingleChart('historyCanvasProtein',  data, 'protein',  '#f06060', 180);
  drawSingleChart('historyCanvasCalories', data, 'calories', '#a060f0', 180);
  drawSingleChart('historyCanvasVitScore', data, 'vitScore', '#60b0f0', 180, 100);
  drawTopGapsHeatmap(data);
}

function drawTopGapsHeatmap(data) {
  const el = document.getElementById('topGapsHeatmap');
  if (!el) return;

  // Find the 5 nutrients with the lowest average % RDA across all days
  const avgPcts = VIT_META.map(m => {
    const avg = data.reduce((s, d) => s + (d.vitPcts[m.key]||0), 0) / data.length;
    return { ...m, avg };
  });
  avgPcts.sort((a, b) => a.avg - b.avg);
  const top5 = avgPcts.slice(0, 5);

  // Build heatmap table: rows = nutrients, cols = days
  const dayHeaders = data.map(d => `<th>${escHtml(d.label)}</th>`).join('');
  const rows = top5.map(m => {
    const cells = data.map(d => {
      const pct = d.vitPcts[m.key] || 0;
      // Colour: 0%=very dark red, 50%=amber, 100%=green
      const bg = pctToColor(pct);
      const display = Math.round(pct) + '%';
      return `<td><span class="heatmap-cell" style="background:${bg}" title="${m.label}: ${display}">${display}</span></td>`;
    }).join('');
    const avgColor = pctToColor(m.avg);
    return `<tr>
      <td class="nutrient-name">${escHtml(m.label)}</td>
      ${cells}
      <td class="heatmap-avg-col" style="color:${avgColor}">${Math.round(m.avg)}%</td>
    </tr>`;
  }).join('');

  el.innerHTML = `
    <table class="heatmap-table">
      <thead><tr>
        <th class="nutrient-col"></th>
        ${dayHeaders}
        <th>avg</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function pctToColor(pct) {
  // 0% → #3a1010 (dark red), 50% → #3a2a10 (amber), 100% → #1a3a10 (green)
  if (pct >= 100) return '#1a4010';
  if (pct >= 70)  return '#1e3a18';
  if (pct >= 40)  return '#3a2e10';
  if (pct >= 20)  return '#3a1c10';
  return '#3a1010';
}

function drawSingleChart(canvasId, data, series, color, canvasH, fixedMax) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width  = rect.width * dpr;
  canvas.height = canvasH   * dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const W = rect.width;
  const H = canvasH;
  const PAD = { top: 18, right: 16, bottom: 34, left: 46 };
  const chartW = W - PAD.left - PAD.right;
  const chartH = H - PAD.top  - PAD.bottom;
  const n = data.length;

  // Max value
  let maxVal = fixedMax || Math.max(...data.map(d => d[series]), 1);
  if (!fixedMax) {
    const mag = Math.pow(10, Math.floor(Math.log10(maxVal)));
    maxVal = Math.ceil(maxVal / mag) * mag;
  }

  ctx.clearRect(0, 0, W, H);

  // Grid lines + y labels
  const gridLines = 4;
  ctx.font = '10px "DM Mono", monospace';
  ctx.fillStyle = '#6a6b60';
  ctx.strokeStyle = '#2a2b26';
  ctx.lineWidth = 1;
  for (let i = 0; i <= gridLines; i++) {
    const y = PAD.top + chartH - (i / gridLines) * chartH;
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    ctx.beginPath();
    ctx.moveTo(PAD.left, y);
    ctx.lineTo(PAD.left + chartW, y);
    ctx.stroke();
    ctx.fillText(Math.round((i / gridLines) * maxVal), PAD.left - 6, y);
  }

  // X positions — always full width
  const xPos = i => n === 1 ? PAD.left + chartW / 2 : PAD.left + (i / (n - 1)) * chartW;

  // X labels — use just day number, add month only if it changes from previous
  ctx.textBaseline = 'top';
  ctx.font = '10px "DM Mono", monospace';
  data.forEach((d, i) => {
    const x = xPos(i);
    ctx.fillStyle = '#6a6b60';
    // Align: left for first, right for last, center for middle
    ctx.textAlign = i === 0 ? 'left' : i === n - 1 ? 'right' : 'center';
    // Short label: just the day number
    const parts = d.label.split(' '); // e.g. ["25", "Feb"]
    const dayNum = parts[0];
    const month = parts[1] || '';
    // Show month only on first point or when month changes
    const prevMonth = i > 0 ? (data[i-1].label.split(' ')[1] || '') : null;
    const showMonth = i === 0 || month !== prevMonth;
    ctx.fillText(showMonth ? dayNum + ' ' + month : dayNum, x, PAD.top + chartH + 8);
  });

  // Gradient fill
  const grad = ctx.createLinearGradient(0, PAD.top, 0, PAD.top + chartH);
  grad.addColorStop(0, color + '33');
  grad.addColorStop(1, color + '00');
  ctx.beginPath();
  data.forEach((d, i) => {
    const x = xPos(i);
    const y = PAD.top + chartH - (d[series] / maxVal) * chartH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.lineTo(xPos(n - 1), PAD.top + chartH);
  ctx.lineTo(xPos(0), PAD.top + chartH);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 2.5;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  data.forEach((d, i) => {
    const x = xPos(i);
    const y = PAD.top + chartH - (d[series] / maxVal) * chartH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Dots + value labels
  ctx.font = '9px "DM Mono", monospace';
  data.forEach((d, i) => {
    const x = xPos(i);
    const y = PAD.top + chartH - (d[series] / maxVal) * chartH;
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.beginPath();
    ctx.arc(x, y, 2, 0, Math.PI * 2);
    ctx.fillStyle = '#0e0f0c';
    ctx.fill();
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    ctx.fillStyle = color;
    ctx.fillText(Math.round(d[series]), x, y - 6);
  });
}

function renderTotals() {
  const t = foods.reduce((acc, f) => {
    acc.protein  += f.protein  || 0;
    acc.carbs    += f.carbs    || 0;
    acc.fat      += f.fat      || 0;
    acc.fatSat   += f.fatSat   || 0;
    acc.fatUnsat += f.fatUnsat || 0;
    acc.fibre    += f.fibre    || 0;
    acc.calories += f.calories || 0;
    return acc;
  }, { protein:0, carbs:0, fat:0, fatSat:0, fatUnsat:0, fibre:0, calories:0 });

  const fmt = v => (Math.round(v * 10) / 10).toFixed(1);
  document.getElementById('totalProtein').textContent = fmt(t.protein)  + 'g';
  document.getElementById('totalCarbs').textContent   = fmt(t.carbs)    + 'g';
  document.getElementById('totalFat').textContent     = fmt(t.fat)      + 'g';
  document.getElementById('totalFibre').textContent   = fmt(t.fibre)    + 'g';
  document.getElementById('totalCal').textContent     = t.calories + ' kcal';

  const goals = getGoals();
  const pct = (v, goal) => Math.min(100, (v / goal) * 100).toFixed(1);
  document.getElementById('barProtein').style.width = pct(t.protein,  goals.protein)  + '%';
  document.getElementById('barCarbs').style.width   = pct(t.carbs,    goals.carbs)    + '%';
  document.getElementById('barFat').style.width     = pct(t.fat,      goals.fat)      + '%';
  document.getElementById('barFibre').style.width   = pct(t.fibre,    goals.fibre)    + '%';
  document.getElementById('barCal').style.width     = pct(t.calories, goals.calories) + '%';

  // Fat split bar
  const fatSplitEl = document.getElementById('fatSplitBar');
  if (fatSplitEl) {
    const hasSplitData = t.fatSat > 0 || t.fatUnsat > 0;
    if (hasSplitData && t.fat > 0) {
      const satPct   = Math.min(100, (t.fatSat   / t.fat) * 100).toFixed(1);
      const unsatPct = Math.min(100, (t.fatUnsat / t.fat) * 100).toFixed(1);
      fatSplitEl.innerHTML = `
        <div class="fat-split-track">
          <div class="fat-split-sat"   style="width:${satPct}%"></div>
          <div class="fat-split-unsat" style="width:${unsatPct}%"></div>
        </div>
        <div class="fat-split-legend">
          <span class="fat-split-sat-label">sat ${fmt(t.fatSat)}g</span>
          <span class="fat-split-unsat-label">unsat ${fmt(t.fatUnsat)}g</span>
        </div>`;
      fatSplitEl.style.display = 'block';
    } else {
      fatSplitEl.style.display = 'none';
    }
  }
}

function renderVitChart() {
  const chart = document.getElementById('vitChart');
  if (foods.length === 0) {
    chart.innerHTML = '<div style="color:var(--muted);font-size:0.75rem;text-align:center;padding:32px 0;opacity:0.5;">Add food to see vitamins &amp; minerals</div>';
    return;
  }

  // Sum all vit/mineral values across foods
  const totals = {};
  VIT_KEYS.forEach(k => {
    totals[k] = foods.reduce((sum, f) => sum + (f[k] || 0), 0);
  });

  // Build HTML grouped by section
  let html = '';
  let lastSection = null;

  VIT_META.forEach(meta => {
    if (meta.section !== lastSection) {
      if (lastSection !== null) html += '<hr class="chart-divider">';
      html += `<div class="vit-section-label">${meta.section}</div>`;
      lastSection = meta.section;
    }

    const rdas  = getRDAs();
    const val   = totals[meta.key];
    const pct   = Math.min(100, (val / (rdas[meta.key] || meta.rda)) * 100).toFixed(1);
    const disp  = val % 1 === 0 ? val : val.toFixed(1);
    // colour the bar fill red if under 30% RDA, yellow 30-70%, green otherwise
    const fillColor = pct < 30 ? meta.color + '88' : pct < 70 ? meta.color + 'bb' : meta.color;

    html += `
      <div class="bar-row vit-bar" style="--vit-color:${meta.color}" onclick="toggleBreakdown('${meta.key}','${meta.unit}')">
        <div class="bar-row-header">
          <span class="bar-label" style="display:inline-flex;align-items:center">${meta.label}<i class="tip-icon" onclick="event.stopPropagation();openTipModal('${meta.key}')">i</i></span>
          <span class="bar-value">${disp}${meta.unit}</span>
        </div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${pct}%;background:${fillColor};transition:width 0.5s cubic-bezier(0.4,0,0.2,1)"></div>
        </div>
        <div class="breakdown-panel" id="bd-${meta.key}"></div>
      </div>`;
  });

  chart.innerHTML = html;
}

// ─── Interactions ─────────────────────────────────────────────────────────────

function updateMacro(id, field, value) {
  const food = foods.find(f => f.id === id);
  if (!food) return;
  food[field] = Math.max(0, round1(value));

  if (['protein', 'carbs', 'fat'].includes(field)) {
    food.calories = Math.round((food.protein * 4) + (food.carbs * 4) + (food.fat * 9));
    const item = document.getElementById('item-' + id);
    if (item) {
      const calInput = item.querySelectorAll('.macro-input')[4];
      if (calInput) calInput.value = food.calories;
    }
  }

  save();
  saveToMemory(food);
  renderTotals();
  renderVitChart();
}

function removeFood(id) {
  foods = foods.filter(f => f.id !== id);
  save();
  renderAll();
}

function clearAll() {
  if (foods.length === 0) return;
  if (!confirm('Remove all food logged today?')) return;
  foods = [];
  save();
  renderAll();
}

function newDay() {
  if (foods.length === 0) {
    showError('Nothing logged today yet — add some food first!');
    return;
  }
  // Save to history
  const history = JSON.parse(localStorage.getItem('mangotrack_history') || '[]');
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-GB', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  history.unshift({ date: dateStr, ts: now.getTime(), foods: JSON.parse(JSON.stringify(foods)) });
  localStorage.setItem('mangotrack_history', JSON.stringify(history));
  // Clear today
  foods = [];
  save();
  renderAll();
  // Switch to history tab
  const histBtn = document.querySelectorAll('.tab-btn')[1];
  if (histBtn) switchTab('history', histBtn);
}

function save() {
  localStorage.setItem('macrotrack_foods', JSON.stringify(foods));
}

// ─── Tab switching ────────────────────────────────────────────────────────────
function switchTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'history') renderHistory();
  if (name === 'ask') updateAskContextBar();
  if (name === 'goals') loadGoalsTab();
}

// ─── History rendering ────────────────────────────────────────────────────────
function renderHistory() {
  const history = JSON.parse(localStorage.getItem('mangotrack_history') || '[]');
  const container = document.getElementById('historyList');
  if (!container) return;

  if (history.length === 0) {
    container.innerHTML = '<div class="history-empty">No history yet. Use ⊕ New Day to archive today and start fresh.</div>';
    document.getElementById('historyChartPanel').style.display = 'none';
    return;
  }

  document.getElementById('historyChartPanel').style.display = 'block';
  drawHistoryChart();

  container.innerHTML = history.map((day, di) => {
    const totals = day.foods.reduce((a, f) => ({
      protein:  a.protein  + (f.protein  || 0),
      carbs:    a.carbs    + (f.carbs    || 0),
      fat:      a.fat      + (f.fat      || 0),
      calories: a.calories + (f.calories || 0),
    }), { protein:0, carbs:0, fat:0, calories:0 });

    const foodRows = day.foods.map((f, fi) => `
      <div class="history-food-row">
        <span class="history-food-name">${escHtml(f.name)}</span>
        <span class="history-food-macros">
          <span style="color:var(--protein)">${f.protein}g P</span>
          <span style="color:var(--carbs)">${f.carbs}g C</span>
          <span style="color:var(--fat)">${f.fat}g F</span>
          <span style="color:var(--cal)">${f.calories} kcal</span>
        </span>
        <button class="history-delete-btn" onclick="deleteHistoryFood(${di},${fi})">✕</button>
      </div>`).join('');

    return `
      <div class="history-day" id="hday-${di}">
        <div class="history-day-header" onclick="toggleHistoryDay(${di})">
          <div class="history-day-top">
            <div style="display:flex;align-items:center;gap:8px">
              <div class="history-day-date" id="hday-date-${di}">${escHtml(day.date)}</div>
              <button class="history-edit-date-btn" onclick="event.stopPropagation();editHistoryDate(${di})" title="Edit date">edit</button>
            </div>
            <span class="history-chevron">▼</span>
          </div>
          <div class="history-day-summary">
            <span class="history-macro-badge p">${(Math.round(totals.protein*10)/10)}g protein</span>
            <span class="history-macro-badge c">${(Math.round(totals.carbs*10)/10)}g carbs</span>
            <span class="history-macro-badge f">${(Math.round(totals.fat*10)/10)}g fat</span>
            <span class="history-macro-badge k">${totals.calories} kcal</span>
          </div>
        </div>
        <div class="history-day-foods">${foodRows}</div>
      </div>`;
  }).join('');
}

function toggleHistoryDay(di) {
  const el = document.getElementById('hday-' + di);
  if (el) el.classList.toggle('open');
}

function editHistoryDate(di) {
  const history = JSON.parse(localStorage.getItem('mangotrack_history') || '[]');
  if (!history[di]) return;
  const current = history[di].date;
  const el = document.getElementById('hday-date-' + di);
  if (!el) return;

  // Replace label with an input
  el.innerHTML = `<input class="history-date-input" id="hday-input-${di}" value="${escHtml(current)}" style="background:var(--bg);border:1px solid var(--accent);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;padding:2px 8px;border-radius:4px;width:220px;" />`;
  const input = document.getElementById('hday-input-' + di);
  input.focus();
  input.select();

  const save = () => {
    const newDate = input.value.trim();
    if (newDate && newDate !== current) {
      history[di].date = newDate;
      localStorage.setItem('mangotrack_history', JSON.stringify(history));
    }
    renderHistory();
  };

  input.addEventListener('blur', save);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { renderHistory(); }
  });
}

function deleteHistoryFood(dayIdx, foodIdx) {
  const history = JSON.parse(localStorage.getItem('mangotrack_history') || '[]');
  if (!history[dayIdx]) return;
  history[dayIdx].foods.splice(foodIdx, 1);
  if (history[dayIdx].foods.length === 0) history.splice(dayIdx, 1);
  localStorage.setItem('mangotrack_history', JSON.stringify(history));
  renderHistory();
}

function setLoading(on) {
  document.getElementById('loadingBar').classList.toggle('active', on);
  document.getElementById('mangoAddBtn').disabled = on;
  document.getElementById('mangoAddBtn').textContent = on ? '...' : '+ Add';
}

function showError(msg) {
  const el = document.getElementById('errorToast');
  el.textContent = msg;
  el.classList.add('show');
}

function hideError() {
  document.getElementById('errorToast').classList.remove('show');
}



function openTipModal(key) {
  const meta = VIT_META.find(m => m.key === key);
  if (!meta) return;
  document.getElementById('tipModalTitle').textContent = meta.label;
  document.getElementById('tipModalBody').textContent = meta.tip;
  document.getElementById('tipModal').classList.add('open');
}

function closeTipModal() {
  document.getElementById('tipModal').classList.remove('open');
}

// ─── Custom confirm modal ─────────────────────────────────────────────────────
let _confirmResolve = null;

function showConfirm(title, msg, okLabel, onOk, infoOnly = false) {
  const modal = document.getElementById('confirmModal');
  const msgEl = document.getElementById('confirmMsg');
  const okBtn = document.getElementById('confirmOkBtn');
  const cancelBtn = modal.querySelector('.confirm-cancel');

  msgEl.innerHTML = '<strong>' + escHtml(title) + '</strong>' + escHtml(msg);
  okBtn.textContent = okLabel || 'Confirm';
  cancelBtn.style.display = infoOnly ? 'none' : '';
  _confirmResolve = onOk;
  modal.classList.add('open');
}

function resolveConfirm(confirmed) {
  document.getElementById('confirmModal').classList.remove('open');
  if (confirmed && typeof _confirmResolve === 'function') {
    _confirmResolve();
  }
  _confirmResolve = null;
}




// ─── Nutrient breakdown panels ────────────────────────────────────────────────
function renderBreakdownPanel(key, unit) {
  const panel = document.getElementById('bd-' + key);
  if (!panel || !panel.classList.contains('open')) return;

  const contributions = foods
    .map(f => ({ id: f.id, name: f.name, val: round1(f[key] || 0) }))
    .filter(r => r.val > 0)
    .sort((a, b) => b.val - a.val);

  if (contributions.length === 0) {
    panel.innerHTML = '<div class="breakdown-row" style="color:var(--muted);font-size:0.68rem">No contributions yet</div>';
    return;
  }

  const maxVal = contributions[0].val;
  const colorMap = { protein:'var(--protein)', carbs:'var(--carbs)', fat:'var(--fat)',
    fibre:'var(--fibre)', calories:'var(--cal)' };
  const color = colorMap[key] || 'var(--vit)';

  panel.innerHTML = contributions.map(r => {
    const barW = Math.round((r.val / maxVal) * 100);
    const dispVal = r.val % 1 === 0 ? r.val : r.val.toFixed(1);
    return `
      <div class="breakdown-row" id="bdrow-${r.id}-${key}">
        <span class="breakdown-food-name">${escHtml(r.name)}</span>
        <span class="breakdown-bar-track">
          <span class="breakdown-bar-fill" style="width:${barW}%;background:${color}"></span>
        </span>
        <span class="breakdown-amount">
          <button class="breakdown-amount-btn" onclick="event.stopPropagation();startNutrientEdit(${r.id},'${key}','${unit}')">${dispVal}${unit}</button>
        </span>
      </div>`;
  }).join('');
}

function toggleBreakdown(key, unit) {
  if (foods.length === 0) return;
  const panel = document.getElementById('bd-' + key);
  if (!panel) return;
  panel.classList.toggle('open');
  renderBreakdownPanel(key, unit);
}

function startNutrientEdit(foodId, key, unit) {
  const food = foods.find(f => f.id === foodId);
  if (!food) return;
  const row = document.getElementById('bdrow-' + foodId + '-' + key);
  if (!row) return;

  const current = round1(food[key] || 0);
  const amountCell = row.querySelector('.breakdown-amount');
  amountCell.innerHTML = `
    <span class="breakdown-inline-edit">
      <input class="breakdown-inline-input" id="bdinput-${foodId}-${key}"
        type="number" min="0" step="0.1" value="${current}"
        onkeydown="if(event.key==='Enter'){event.stopPropagation();saveNutrientEdit(${foodId},'${key}','${unit}')}
                   if(event.key==='Escape'){event.stopPropagation();renderBreakdownPanel('${key}','${unit}')}"
      />
      <button class="breakdown-inline-save" onclick="event.stopPropagation();saveNutrientEdit(${foodId},'${key}','${unit}')">✓</button>
      <button class="breakdown-inline-cancel" onclick="event.stopPropagation();renderBreakdownPanel('${key}','${unit}')">✕</button>
    </span>`;

  // Focus and select the input
  const inp = document.getElementById('bdinput-' + foodId + '-' + key);
  if (inp) { inp.focus(); inp.select(); }
}

function saveNutrientEdit(foodId, key, unit) {
  const food = foods.find(f => f.id === foodId);
  if (!food) return;
  const inp = document.getElementById('bdinput-' + foodId + '-' + key);
  if (!inp) return;
  const newVal = round1(Math.max(0, parseFloat(inp.value) || 0));
  food[key] = newVal;
  save();
  saveToMemory(food);
  // Re-render charts and re-render the breakdown panel in place
  renderTotals();
  renderVitChart();
  renderBreakdownPanel(key, unit);
  // Re-open the panel (renderVitChart closes it by rebuilding HTML)
  const panel = document.getElementById('bd-' + key);
  if (panel) panel.classList.add('open');
}

function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─── Recommendations ──────────────────────────────────────────────────────────

async function getRecommendations() {
  if (foods.length === 0) return;

  const btn     = document.getElementById('recBtn');
  const cards   = document.getElementById('recCards');
  const btnText = document.getElementById('recBtnText');

  btn.disabled = true;
  btnText.textContent = 'Thinking…';
  cards.innerHTML = '<div class="rec-loading">Analysing your gaps and finding the best foods…</div>';

  // Build gap summary for the prompt
  const totals = {};
  VIT_KEYS.forEach(k => { totals[k] = foods.reduce((s, f) => s + (f[k] || 0), 0); });

  const gaps = VIT_META
    .map(m => ({ ...m, pct: Math.min(100, (totals[m.key] / m.rda) * 100) }))
    .filter(m => m.pct < 100)
    .sort((a, b) => a.pct - b.pct)
    .slice(0, 8)
    .map(m => `${m.label}: ${m.pct.toFixed(0)}% of RDA (${(Math.round((totals[m.key])*10)/10)}${m.unit} of ${m.rda}${m.unit})`)
    .join(', ');

  const eaten = foods.map(f => f.name).join(', ');

  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-6",
        max_tokens: 1000,
        system: `You are a nutrition advisor. Given a person's micronutrient gaps and what they've already eaten today, recommend exactly 3 foods that would most efficiently address the biggest gaps. Return ONLY valid JSON (no markdown) in this exact shape:
[
  {
    "food": "Food name",
    "serving": "e.g. 1 cup / 100g",
    "why": "One sentence explaining why this food is ideal for today's gaps.",
    "nutrients": ["Nutrient A", "Nutrient B", "Nutrient C"]
  }
]
Be specific with food names. Prioritise foods that address multiple gaps at once. Do not repeat foods already eaten today.`,
        messages: [{
          role: "user",
          content: `Already eaten today: ${eaten || 'nothing yet'}.

Top micronutrient gaps: ${gaps || 'none — all at 100%'}.`
        }]
      })
    });

    if (!response.ok) throw new Error('API error');
    const data = await response.json();
    const text = data.content.map(b => b.text || '').join('');
    const recs  = JSON.parse(text.replace(/```json|```/g, '').trim());

    cards.innerHTML = recs.map((r, i) => `
      <div class="rec-card">
        <div class="rec-card-num">Option ${i + 1}</div>
        <div class="rec-card-food">${escHtml(r.food)}</div>
        <div class="rec-card-why">${escHtml(r.serving)} &mdash; ${escHtml(r.why)}</div>
        <div class="rec-card-nutrients">
          ${(r.nutrients || []).map(n => `<span class="rec-nutrient-tag">${escHtml(n)}</span>`).join('')}
        </div>
      </div>
    `).join('');

  } catch(e) {
    cards.innerHTML = '<div class="rec-loading" style="color:var(--protein)">Could not load recommendations. Please try again.</div>';
  }

  btn.disabled = false;
  btnText.textContent = '↺ Refresh';
}

// Show rec section once food is added
function maybeShowRec() {
  const s = document.getElementById('recSection');
  if (s) s.style.display = foods.length > 0 ? 'block' : 'none';
}

// ─── Goals ───────────────────────────────────────────────────────────────────

function getProfile() {
  try {
    const saved = localStorage.getItem('mangotrack_profile');
      return saved ? { ...DEFAULT_PROFILE, ...JSON.parse(saved) } : { ...DEFAULT_PROFILE };
  } catch(e) { return { ...DEFAULT_PROFILE }; }
}

function getRDAs() {
  const p = getProfile();
  const overrides = RDA_OVERRIDES[p.sex + ':' + p.age] || {};
  const rdas = {};
  VIT_META.forEach(m => { rdas[m.key] = overrides[m.key] !== undefined ? overrides[m.key] : m.rda; });
  return rdas;
}

function getGoals() {
  try {
    const saved = localStorage.getItem('mangotrack_goals');
    return saved ? { ...DEFAULT_GOALS, ...JSON.parse(saved) } : { ...DEFAULT_GOALS };
  } catch(e) { return { ...DEFAULT_GOALS }; }
}

function toggleGoalOption(groupId, btn) {
  document.querySelectorAll('#' + groupId + ' .goals-toggle').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  showGoalsActions();
}

function showGoalsActions() {
  document.getElementById('goalsActions').style.display = 'flex';
}

function loadGoalsTab() {
  const g = getGoals();
  document.getElementById('goalProtein').value  = g.protein;
  document.getElementById('goalCarbs').value    = g.carbs;
  document.getElementById('goalFat').value      = g.fat;
  document.getElementById('goalFibre').value    = g.fibre;
  document.getElementById('goalCalories').value = g.calories;

  const p = getProfile();
  document.querySelectorAll('#goalSexGroup .goals-toggle').forEach(b => {
    b.classList.toggle('active', b.dataset.val === p.sex);
  });
  document.querySelectorAll('#goalAgeGroup .goals-toggle').forEach(b => {
    b.classList.toggle('active', b.dataset.val === p.age);
  });
}

function saveGoals() {
  const g = {
    protein:  parseFloat(document.getElementById('goalProtein').value)  || DEFAULT_GOALS.protein,
    carbs:    parseFloat(document.getElementById('goalCarbs').value)    || DEFAULT_GOALS.carbs,
    fat:      parseFloat(document.getElementById('goalFat').value)      || DEFAULT_GOALS.fat,
    fibre:    parseFloat(document.getElementById('goalFibre').value)    || DEFAULT_GOALS.fibre,
    calories: parseFloat(document.getElementById('goalCalories').value) || DEFAULT_GOALS.calories,
  };
  localStorage.setItem('mangotrack_goals', JSON.stringify(g));

  const sexBtn = document.querySelector('#goalSexGroup .goals-toggle.active');
  const ageBtn = document.querySelector('#goalAgeGroup .goals-toggle.active');
  const profile = {
    sex: sexBtn ? sexBtn.dataset.val : DEFAULT_PROFILE.sex,
    age: ageBtn ? ageBtn.dataset.val : DEFAULT_PROFILE.age,
  };
  localStorage.setItem('mangotrack_profile', JSON.stringify(profile));

  renderAll();
  const msg = document.getElementById('goalsSavedMsg');
  msg.textContent = '✓ Goals saved';
  document.getElementById('goalsActions').style.display = 'none';
  setTimeout(() => { msg.textContent = ''; }, 2500);
}

function resetGoals() {
  localStorage.removeItem('mangotrack_goals');
  localStorage.removeItem('mangotrack_profile');
  loadGoalsTab();
  renderAll();
  const msg = document.getElementById('goalsSavedMsg');
  msg.textContent = '✓ Reset to defaults';
  document.getElementById('goalsActions').style.display = 'none';
  setTimeout(() => { msg.textContent = ''; }, 2500);
}

// ─── Ask Tab ──────────────────────────────────────────────────────────────────
let askHistory = [];

function buildAskSystemPrompt() {
  const goals = getGoals();
  const totals = foods.reduce((a, f) => {
    a.protein  += f.protein  || 0;
    a.carbs    += f.carbs    || 0;
    a.fat      += f.fat      || 0;
    a.fibre    += f.fibre    || 0;
    a.calories += f.calories || 0;
    return a;
  }, { protein:0, carbs:0, fat:0, fibre:0, calories:0 });

  const microTotals = {};
  VIT_KEYS.forEach(k => { microTotals[k] = foods.reduce((s, f) => s + (f[k] || 0), 0); });

  const rdas = getRDAs();
  const microGaps = VIT_META.map(m => {
    const rda = rdas[m.key] || m.rda;
    const pct = Math.round((microTotals[m.key] / rda) * 100);
    return { label: m.label, pct, unit: m.unit, current: round1(microTotals[m.key]), rda };
  }).sort((a, b) => a.pct - b.pct);

  const foodList = foods.length
    ? foods.map(f => '- ' + f.name + ' (' + f.serving + '): ' + f.protein + 'g protein, ' + f.carbs + 'g carbs, ' + f.fat + 'g fat, ' + f.calories + ' kcal').join('\n')
    : 'Nothing logged yet today.';

  const macroSummary = 'Protein: ' + round1(totals.protein) + 'g / ' + goals.protein + 'g | Carbs: ' + round1(totals.carbs) + 'g / ' + goals.carbs + 'g | Fat: ' + round1(totals.fat) + 'g / ' + goals.fat + 'g | Fibre: ' + round1(totals.fibre) + 'g / ' + goals.fibre + 'g | Calories: ' + Math.round(totals.calories) + ' / ' + goals.calories + ' kcal';

  const gapSummary = microGaps.slice(0, 8).map(g => g.label + ': ' + g.current + g.unit + ' / ' + g.rda + g.unit + ' (' + g.pct + '%)').join('\n');

  return 'You are a knowledgeable, concise nutrition assistant built into MangoTrack, a personal food tracking app.\n\nThe user\'s food log for today:\n' + foodList + '\n\nToday\'s macro progress:\n' + macroSummary + '\n\nTop nutrient gaps (lowest % of RDA hit today):\n' + gapSummary + '\n\nAnswer nutrition questions clearly and practically. When relevant, reference the user\'s actual food log and gaps. Keep responses focused - 2-4 short paragraphs max. No unnecessary preamble.';
}

function updateAskContextBar() {
  const bar = document.getElementById('askContextBar');
  if (!bar) return;
  if (foods.length === 0) {
    bar.textContent = 'No food logged today - general nutrition questions only.';
    return;
  }
  const totals = foods.reduce((a, f) => {
    a.protein += f.protein || 0; a.calories += f.calories || 0; return a;
  }, { protein:0, calories:0 });
  bar.textContent = foods.length + ' food' + (foods.length > 1 ? 's' : '') + ' logged today · ' + Math.round(totals.calories) + ' kcal · ' + round1(totals.protein) + 'g protein';
}

function askSuggestion(btn) {
  document.getElementById('askInput').value = btn.textContent;
  sendAsk();
}

async function sendAsk() {
  const input = document.getElementById('askInput');
  const sendBtn = document.getElementById('askSendBtn');
  const messagesEl = document.getElementById('askMessages');
  const query = input.value.trim();
  if (!query) return;

  const empty = messagesEl.querySelector('.ask-empty');
  if (empty) empty.remove();

  const userBubble = document.createElement('div');
  userBubble.className = 'ask-bubble user';
  userBubble.textContent = query;
  messagesEl.appendChild(userBubble);

  const thinkingBubble = document.createElement('div');
  thinkingBubble.className = 'ask-bubble thinking';
  thinkingBubble.textContent = 'Thinking...';
  messagesEl.appendChild(thinkingBubble);

  input.value = '';
  sendBtn.disabled = true;
  messagesEl.scrollTop = messagesEl.scrollHeight;

  askHistory.push({ role: 'user', content: query });

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 1000,
        system: buildAskSystemPrompt(),
        messages: askHistory
      })
    });
    const data = await response.json();
    const reply = data.content && data.content[0] ? data.content[0].text : 'Sorry, could not get a response.';
    askHistory.push({ role: 'assistant', content: reply });
    thinkingBubble.className = 'ask-bubble assistant';
    thinkingBubble.textContent = reply;
  } catch(err) {
    thinkingBubble.className = 'ask-bubble assistant';
    thinkingBubble.textContent = 'Something went wrong. Please try again.';
    askHistory.pop();
  }

  sendBtn.disabled = false;
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

</script>
</body>
</html>
